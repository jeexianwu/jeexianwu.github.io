---
layout: default
title: 使用PPTP翻墙
comments: true
categories: [other]
---

## 使用PPTP翻墙
---
2014-08-01

之前使用OpenVPN翻墙，配置太麻烦了，而且还需要客户端软件支持，而且还需要生成证书做分发. 在公司用了同事配置好的PPTP，发现特别简单，MacOS客户端只需要在网络连接里添加VPN就行了.

参考原文：[http://www.dabu.info/centos6-4-structures-pptp-vpn.html](http://www.dabu.info/centos6-4-structures-pptp-vpn.html)

OpenVPN与PPTP的比较：

- PPTP没有OpenVPN安全，但是配置简单，只需要密码即可进行使用，有部分VPS运营商不支持PPTP.
- OpenVPN更加安全，但是配置麻烦，并且需要客户端软件做配合，有些设备不支持.

### 1.检查环境是否支持

    #modprobe ppp-compress-18 && echo ok // 结果显示`ok`说明支持ppp.
    #cat /dev/net/tun   //结果显示`cat: /dev/net/tun: File descriptor in bad state`表示可以使用pptp.
    #rpm -q ppp         //查询当前系统的ppp是否默认集成了，以及ppp的版本
    #strings '/usr/sbin/pppd' |grep -i mppe | wc --lines    //如果已经安装ppp，则检查PPP是否支持MPPE(微软点对点加密)

### 2.安装所需的软件

    yum install -y perl ppp iptables
    rpm -Uvh http://poptop.sourceforge.net/yum/stable/rhel6/pptp-release-current.noarch.rpm // 添加pptp的rpm源
    yum install pptpd

### 3.配置
    
#### 3.1. 配置options.pptpd

    #cp /etc/ppp/options.pptpd /etc/ppp/options.pptpd.bak  //备份原配置文件
    #vim /etc/ppp/options.pptpd

在配置文件中将DNS改为Google的：

    ms-dns 8.8.8.8
    ms-dns 8.8.4.4

#### 3.2. 配置chap-secrets, 客户端账号

    #cp  /etc/ppp/chap-secrets /etc/ppp/chap-secrets.bak
    #vim  /etc/ppp/chap-secrets

    myusername      pptpd     mypassword     *  // *表示任意IP地址

注意这里的pptpd是之前配置的name.

#### 3.3. 配置/etc/pptpd.conf

    #cp   /etc/pptpd.conf /etc/pptpd.conf.bak
    #vim /etc/pptpd.conf

`pptpd.conf`所有需要的配置：

    option /etc/ppp/options.pptpd
    logwtmp
    localip 192.168.9.1
    remoteip 192.168.9.11-30 //表示vpn客户端获得ip的范围

`pptpd.conf这个配置文件必须保证最后是以空行结尾才行`, 暂时不知真假，反正我自己先空了一行，防止返工.

#### 3.4. 配置文件/etc/sysctl.conf
    
    #vim /etc/sysctl.conf //修改内核设置，使其支持转发

将net.ipv4.ip_forward = 0 改成 net.ipv4.ip_forward = 1

    #/sbin/sysctl -p    // 保存并使修改后的文件生效.

### 4. 启动pptp和iptables

    #/sbin/service pptpd start 或者 #service pptpd start

目前我们就可以用客户端连上这个VPN了，但是还不能做任何网络访问，因为我们还需要配置iptables的转发规则:

    #/sbin/iptables -t nat -A POSTROUTING -o eth0 -s 192.168.9.0/24 -j MASQUERADE

或者(我用下面明确指定IP地址的方式成功了，上面那种是自动检测地址)
    
    #iptables -t nat -A POSTROUTING -o eth0 -s 192.168.9.0/24 -j SNAT --to-source 128.199.229.101

然后
    #/etc/init.d/iptables save
    #/sbin/service iptables restart 

注意这里的eth0是你的外网网卡，192.168.9.0是你之前配置的pptpd内网网段.

    #service pptpd restart  // 重启pptpd
    #chkconfig pptpd on //开机启动pptp vpn服务
    #chkconfig iptables on //开机启动iptables

全部完成，客户端直接使用系统自带的VPN网络配置即可连接.