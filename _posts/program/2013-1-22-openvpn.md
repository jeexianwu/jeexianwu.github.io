---
layout: default
title: 使用OpenVPN翻墙的安装设置
comments: true
categories: [program]
---

## 使用OpenVPN翻墙的安装设
---
2013-1-22

由于公司可以的网络直接是翻过墙的，所以在家里也就懒得翻墙了，但是这几天发现Github竟然被墙了，我的业余生活完全没法过了......

正好有一个日本的VPS，就配置一下OpenVPN翻墙吧。

### 服务器端
---
服务器是CentOS 5的操作系统，安装软件很简单：

    yum install openvpn

缺什么补装什么就行了，有yum还是很爽的，当然这个过程还是比较麻烦的，有几个软件我不得不下载源码包安装，自己体验一下吧，安装步骤可以[参考这里](https://safesrv.net/install-openvpn-on-centos/)，但配置步骤不建议参考它，我配置没成功。

安装好了之后，为了以后使用方便，我们把openvpn可执行文件复制到/etc下：

    cp -R /usr/share/doc/openvpn-2.2.2/easy-rsa/ /etc/openvpn/

然后进入到/etc/openvpn/2.0/目录，分别执行以下命令：

    source ./vars          #初始化环境变量

清理以前的旧证书、密钥：
  
    ./clean-all

生成服务器端的证书，需要填写一些基本信息，可以不填或者随便填一下就行：

    ./build-ca

生成服密钥服务器，server-name可以改成自己的服务器名字，后面配置要用，这一步需要输入密钥的密码，填不填都行：

    ./build-key-server server-name

然后就可以生成客户端需要的证书了，注意这里每个客户端会生成三个文件，分别为：client1.key, client1.crt, client1.csr，这是三个文件和ca.crt一起要发给客户端用：

    ./build-key client1
    ./build-key client2

最后一步就是对刚才创建的客户端证书进行dh加密了：

    ./build-dh

加密完成之后，我们需要配置vpn服务器才能启动它，把安装文件中的示例复制过来：

    cp /usr/share/doc/openvpn-2.2.2/sample-config-files/server.conf /etc/openvpn

然后修改其中的关键部分，如协议是udp还是tcp，监听地址是不是本机等，需要特别修改的是：

    local a.b.c.d                              //改成VPS地址，注释掉表示本机
    prot 1194                                  //如果没有特别需要，可以不用修改
    proto udp                                  //也可以不做修改
    dev tun                                    
    //以下是公钥密钥部分，注意server-name是上面指定的！
    ca /etc/openvpn/easy-rsa/2.0/keys/ca.crt
    cert /etc/openvpn/easy-rsa/2.0/keys/server-name.crt
    key /etc/openvpn/easy-rsa/2.0/keys/server-name.key
    dh /etc/openvpn/easy-rsa/2.0/keys/dh1024.pem
    push "redirect-gateway def1 bypass-dhcp"   //取消注释即可
    push "dhcp-option DNS 208.67.222.222"      //取消注释即可
    push "dhcp-option DNS 208.67.220.220"      //取消注释即可
    client-to-client                           //取消注释即可

目前为止，服务器端的OpenVPN就配置好了，即客户端可以和服务器通信，但是我们还需要服务器把客户端的请求转发到外网并把外网的数据返回，需要以下步骤：

编辑/etc/sysctl.conf，把 net.ipv4.ip_forward = 0 修改为 1

然后使用sysctl -p命令使配置立即生效，最后修改iptables转发规则：

Xen或KVM服务器([服务器检测方式](http://unix.stackexchange.com/questions/89714/easy-way-to-determine-virtualization-technology)):
    
    iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE

OpenVZ服务器：

    iptables -t nat -A POSTROUTING -o venet0 -j SNAT --to-source a.b.c.d
    iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -j SNAT --to-source a.b.c.d

其中a.b.c.d为服务器ip地址(上面的命令表示客户端的请求经过服务器时，源地址改写为a.b.c.d，即服务器地址)，然后保存配置并重启:

    /etc/init.d/iptables save
    /etc/init.d/iptables restart

下面使用：

    /usr/sbin/openvpn –-config /etc/openvpn/server.conf

指定配置文件启动，没有问题的话可以用ctrl+c退出，然后使用

    service openvpn restart

后台重新启动服务即可。

### 客户端
---
把我们上面生成的client1.key, client1.crt, client1.csr和ca.crt拷贝到客户端。

我家里要翻墙的机器是win7系统，所以到官网下载一个OpenVPN客户端，把上面的四个文件放到config目录下，同时从客户端根目录的sample-config中拷贝一个client.ovpn文件放进config中。

对客户端的配置文件只需要修改：

    remote a.b.c.d 1194               //改成VPS上设置的地址和端口号
    ca ca.crt                                 //下载下来的证书，及密钥
    cert client1.crt
    key client1.key

然后点击connect即可连接。
